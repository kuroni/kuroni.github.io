<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> A somewhat-not-short blog on flow with demands | Trung Dang </title> <meta name="author" content="Trung Dang"> <meta name="description" content="Flow with demands tutorial"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://kuroni.github.io/blog/2022/flow-with-demands/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Trung</span> Dang </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/books/">bookshelf</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">A somewhat-not-short blog on flow with demands</h1> <p class="post-meta"> Created on July 08, 2022 </p> <p class="post-tags"> <a href="/blog/2022"> <i class="fa-solid fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/competitive-programming"> <i class="fa-solid fa-hashtag fa-sm"></i> competitive-programming</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>I started trying to learn about flows with demands about 3-4 years ago while in high school from <a href="https://cp-algorithms.com/graph/flow_with_demands.html" rel="external nofollow noopener" target="_blank">this cp-algorithm post</a>, but for some reason the construction presented in that blog was pretty alien and unintuitive for me, so I never really understood how it worked. As I entered college and took my algorithm class though, I was introduced to this extremely nice construction that stuck with me from that day, and it even helped me earn my first publication.</p> <p><em>Quick warning</em>: The blog will include a lot of linear program formulation of the flow problem, but I assure you that the formulation is very easy to understand :)</p> <h3 id="the-problem">The problem</h3> <p>You are probably familiar with the flow problem: Given a graph \(G = (V, E)\), in which two special vertices called the source \(s\) and the sink \(t\) are given. Each edge \((u, v)\) in the graph is also given a <strong>capacity</strong> \(c(u, v)\). Then, a <em>flow</em> from \(s\) to \(t\) is defined as a way to assign \(f(u, v)\) to all edges \((u, v)\) such that:</p> \[\begin{align*} 0 \le f(u, v) &amp;\le c(u, v) &amp; (\forall (u, v) \in E) \\ \sum_{(u_1, v) \in E} f(u_1, v) &amp;= \sum_{(v, u_2) \in E} f(v, u_2) &amp; (\forall v \in V \setminus \{s, t\}) \\ \end{align*}\] <p>where the second condition is commonly referred to as <em>conservation of flows</em>: the sum of the flows entering a node \(v\) must equal the sum of the flows exiting that same node. The <em>value</em> of a flow is just the sum of flows exiting the source \(s\) (or entering the sink \(t\)), and the maximum flow problem asks us to maximize this value.</p> <p>The <em>flow with demands</em> (or <em>flow with edge lower bounds</em>) problem simply generalizes the lower bound condition on the flow of each edge: We are now given a non-negative lower bound \(l(u, v)\) on each edge, and now we need to find a flow that satisfies \(l(u, v) \le f(u, v) \le c(u, v)\) for all edges.</p> <h3 id="an-extension-of-the-flow-problem-the-circulation-problem">An extension of the flow problem: the circulation problem</h3> <p>I don’t know if it’s only me, but I find the definition of the flow problem rather ugly. What’s with leaving out \(s\) and \(t\) in the conservation of flows constraints??</p> <p>It turns out that not leaving out \(s\) and \(t\) leads to a different type of problem called <em>the circulation problem</em>. It turns out that we can solve a lot of flow problems by simply adding the edge \((t, s)\) with capacity \(c(t, s) = \infty\) and solve the equivalent circulation problem on the modified graph; it is pretty easy to see that each flow on \(G\) is equivalent to a circulation on the modified graph. There is also another property we can spot here: the value of the flow is actually \(f(t, s)\)!</p> <h3 id="circulation-with-node-demands">Circulation with node demands</h3> <p>Let’s go even crazier with the generalization. So far the conservation of flows constraint has been pretty intuitive: flow going in = flow going out. Let’s add node demands and supplies: if a node has a demand, it takes in more flow than it spits out; conversely, a node with a supply can spits out more flow than it intakes. More formally, if we let each node’s demand be \(d(u)\) (where supply is denoted as negative demand), the problem asks us to find \(f(u, v)\) such that:</p> \[\begin{align*} 0 \le f(u, v) &amp;\le c(u, v) &amp; (\forall (u, v) \in E) \\ \sum_{(u_1, v) \in E} f(u_1, v) - \sum_{(v, u_2) \in E} f(v, u_2) &amp;= d(v) &amp; (\forall v \in V) \\ \end{align*}\] <p>To solve this problem, let’s create a new graph \(G' = (V', E')\). First, we add the same nodes and edges from \(G\) to \(G'\), then we create a new source \(s'\) and a new sink \(t'\). Finally, for each node \(u\) with a demand, add an edge \((u, t')\) with capacity \(c(u, t') = d(u)\); similarly, for each node \(u\) with a supply, add an edge \((s, u')\) with capacity \(c(s, u') = -d(u)\). Intuitively, each of these edges is there to balance out the demand/supply so that the conservation of flows on every node is preserved. Finally, we simply run the max flow algorithm on this new graph; if all edges from \(s'\) and to \(t'\) are saturated, this means all supplies and demands are satisfied, which means the resulting max flow can be mapped to a feasible circulation.</p> <h3 id="solving-flow-with-edge-lower-bounds">Solving flow with edge lower bounds</h3> <p>Now, we finally tackle our original problem. From the original flow with edge lower bounds problem, we add an edge from \(t\) to \(s\) with capacity \(c(t, s) = \infty\) and lower bound \(l(t, s) = 0\) to obtain a circulation with edge lower bounds problem.</p> <p>Let’s analyze the local structure of each node: it has some incoming edges and outcoming edges, each with its own lower bound \(l(u, v)\) and capacity \(c(u, v)\). Instead of thinking of \(l(u, v)\)’s as lower bounds, let’s think of them as the “forced” flow that must go through each edge, and the actual “capacity” is actually just \(c(u, v) - l(u, v)\). Additionally, since \(l(u, v)\)’s are “forced”, the conservation of flows on the node may not be true, but we already have the tool to solve this: we just say that the demand of node \(v\) as the amount of flow \(v\) must “intake” to satisfy the conservation of flows, i.e. \(d(v) = \sum_{(u_1, v) \in E} l(u_1, v) - \sum_{(v, u_2) \in E} l(v, u_2)\).</p> <p>To recap:</p> <ul> <li>From a flow with edge lower bounds problem, add edge \((t, s)\) with \(c(t, s) = \infty\) and \(l(t, s) = 0\) to obtain a circulation with edge lower bounds problem.</li> <li>From a circulation with edge lower bounds problem, for each edge \((u, v)\), let its new capacity \(c'(u, v)\) be \(c(u, v) - l(u, v)\); additionally, for each node \(v\), let its demand be \(d(v) = \sum_{(u_1, v) \in E} l(u_1, v) - \sum_{(v, u_2) \in E} l(v, u_2)\). We then obtain a circulation with node demands problem.</li> <li>Create two new sources \(s'\) and \(t'\), and connect each node to either \(s'\) or \(t'\) with the capacity being \(\|d(u)\|\). We can now solve the ciruclation with node demands problem by running max flow on this new graph.</li> </ul> <h3 id="some-generalizations">Some generalizations</h3> <p>Let’s tackle some more generalizations. The construction so far only allows us to find the existence of any flow with the correct lower bounds. What if we want to find, say, the max flow (or min flow) among all feasible answers?</p> <p>Notice our previous observation: the flow \(f(t, s)\) on the back edge from sink to source is the value of our flow. We have been blindly assigning this edge’s lower bound and capacity to be \(0\) and \(\infty\), but we can indeed change these values to reflect our goal. For example, if we want to find the min flow among all feasible answers, we can binary search the capacity of this back edge; similarly, if we want to find the max flow among all feasible answers, we can binary search the lower bound of this back edge.</p> <p>Finally, it is indeed possible to solve the min-cost circulation with node demands problem with our construction, and it turns out that there are also <a href="https://developers.google.com/optimization/flow/mincostflow" rel="external nofollow noopener" target="_blank">solvers</a> to do this quickly (I am not pretending to understand the algorithm behind this solver, but I do know that it comes from <a href="https://www.amazon.com/Network-Flows-Theory-Algorithms-Applications/dp/013617549X" rel="external nofollow noopener" target="_blank">this book</a> and it has a time complexity of \(O(n^2 \cdot m \cdot \log(n \max c))\).</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://wiki.vnoi.info/algo/trick/convex_greedy" target="_blank" rel="external nofollow noopener">Just a moment...</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://wiki.vnoi.info/algo/trick/minkowski-sum" target="_blank" rel="external nofollow noopener">Just a moment...</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://wiki.vnoi.info/algo/math/matroid" target="_blank" rel="external nofollow noopener">Just a moment...</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Trung Dang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: October 09, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>